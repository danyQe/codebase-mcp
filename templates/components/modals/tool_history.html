<!-- Tool Call History Modal - CRITICAL COMPONENT -->
<div id="toolHistoryModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeToolHistory()"></div>
        
        <!-- Modal Content -->
        <div class="relative bg-white rounded-lg shadow-2xl max-w-7xl w-full max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-500 to-purple-600">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-history text-white text-2xl"></i>
                    <div>
                        <h2 class="text-xl font-bold text-white">Tool Call History</h2>
                        <p class="text-blue-100 text-sm">Complete log of all API interactions for analysis</p>
                    </div>
                </div>
                <button onclick="closeToolHistory()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Filters & Actions -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <!-- Search -->
                    <input type="text" id="toolHistorySearch" placeholder="Search tool calls..." 
                           class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           oninput="filterToolHistory()">
                    
                    <!-- Status Filter -->
                    <select id="toolHistoryStatus" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" onchange="filterToolHistory()">
                        <option value="">All Statuses</option>
                        <option value="success">Success Only</option>
                        <option value="error">Errors Only</option>
                    </select>
                    
                    <!-- Route Filter -->
                    <select id="toolHistoryRoute" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" onchange="filterToolHistory()">
                        <option value="">All Routes</option>
                        <!-- Populated dynamically -->
                    </select>
                    
                    <!-- Actions -->
                    <div class="flex space-x-2">
                        <button onclick="exportToolHistory('json')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" title="Export as JSON">
                            <i class="fas fa-download mr-1"></i> JSON
                        </button>
                        <button onclick="exportToolHistory('csv')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" title="Export as CSV">
                            <i class="fas fa-file-csv mr-1"></i> CSV
                        </button>
                        <button onclick="clearToolHistory()" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" title="Clear history">
                            <i class="fas fa-trash mr-1"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Summary -->
            <div class="px-6 py-3 bg-gradient-to-r from-gray-50 to-blue-50 border-b border-gray-200">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900" id="historyTotalCalls">0</div>
                        <div class="text-xs text-gray-600">Total Calls</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="historySuccessCount">0</div>
                        <div class="text-xs text-gray-600">Success</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600" id="historyErrorCount">0</div>
                        <div class="text-xs text-gray-600">Errors</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="historyAvgDuration">0ms</div>
                        <div class="text-xs text-gray-600">Avg Duration</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="historySuccessRate">0%</div>
                        <div class="text-xs text-gray-600">Success Rate</div>
                    </div>
                </div>
            </div>
            
            <!-- History List -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="toolHistoryList" class="space-y-3">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tool History functionality
let currentFilters = {};

function showToolHistory() {
    const modal = document.getElementById('toolHistoryModal');
    modal.classList.remove('hidden');
    
    // Load history
    loadToolHistory();
    
    // Update stats
    updateHistoryStats();
    
    // Populate route filter
    populateRouteFilter();
}

function closeToolHistory() {
    document.getElementById('toolHistoryModal').classList.add('hidden');
}

function loadToolHistory(filters = {}) {
    currentFilters = filters;
    const history = toolLogger.getHistory(filters);
    const container = document.getElementById('toolHistoryList');
    
    if (history.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p class="font-medium">No tool calls recorded yet</p>
                <p class="text-sm">Start using the API and calls will appear here</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = history.map((entry, idx) => {
        const statusColor = entry.status === 'success' ? 'green' : 'red';
        const statusIcon = entry.status === 'success' ? 'check-circle' : 'exclamation-circle';
        
        return `
            <div class="border border-gray-200 rounded-lg hover:shadow-md transition-shadow bg-white">
                <!-- Entry Header -->
                <div class="px-4 py-3 flex items-center justify-between cursor-pointer" onclick="toggleToolHistoryDetails(${idx})">
                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <i class="fas fa-${statusIcon} text-${statusColor}-500"></i>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <span class="font-mono text-sm font-medium text-gray-900">${entry.method}</span>
                                <span class="text-gray-600 truncate">${entry.route}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">
                                ${entry.userAction} • ${formatUtils.formatRelativeTime(entry.timestamp)} • ${formatUtils.formatDuration(entry.duration)}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                            ${entry.statusCode || '—'}
                        </span>
                        <i class="fas fa-chevron-down text-gray-400 transform transition-transform" id="chevron-${idx}"></i>
                    </div>
                </div>
                
                <!-- Entry Details (Collapsible) -->
                <div id="details-${idx}" class="hidden border-t border-gray-200 bg-gray-50">
                    <div class="p-4 space-y-4">
                        <!-- Request -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-upload text-blue-500 mr-2"></i>
                                Request
                            </div>
                            <pre class="bg-white border border-gray-200 rounded-md p-3 text-xs overflow-x-auto max-h-40">${formatUtils.formatJSON(entry.request || {})}</pre>
                        </div>
                        
                        <!-- Response -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-download text-green-500 mr-2"></i>
                                Response
                                <button onclick="copyToClipboard(${JSON.stringify(entry.response).replace(/"/g, '&quot;')})" class="ml-auto text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <pre class="bg-white border border-gray-200 rounded-md p-3 text-xs overflow-x-auto max-h-60">${formatUtils.formatJSON(entry.response || {})}</pre>
                        </div>
                        
                        <!-- Error (if any) -->
                        ${entry.error ? `
                        <div>
                            <div class="text-sm font-medium text-red-700 mb-2 flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                Error
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-md p-3 text-sm text-red-800">
                                ${formatUtils.sanitizeHTML(entry.error)}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Metadata -->
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div>
                                <span class="text-gray-600">Timestamp:</span>
                                <span class="font-medium ml-2">${formatUtils.formatDateTime(entry.timestamp)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Duration:</span>
                                <span class="font-medium ml-2">${formatUtils.formatDuration(entry.duration)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Status:</span>
                                <span class="font-medium ml-2">${entry.status}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Status Code:</span>
                                <span class="font-medium ml-2">${entry.statusCode || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleToolHistoryDetails(idx) {
    const details = document.getElementById(`details-${idx}`);
    const chevron = document.getElementById(`chevron-${idx}`);
    
    if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        details.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

function filterToolHistory() {
    const filters = {
        search: document.getElementById('toolHistorySearch').value,
        status: document.getElementById('toolHistoryStatus').value,
        route: document.getElementById('toolHistoryRoute').value
    };
    
    loadToolHistory(filters);
}

function updateHistoryStats() {
    const stats = toolLogger.getStats();
    
    document.getElementById('historyTotalCalls').textContent = formatUtils.formatNumber(stats.totalCalls);
    document.getElementById('historySuccessCount').textContent = formatUtils.formatNumber(stats.successCount);
    document.getElementById('historyErrorCount').textContent = formatUtils.formatNumber(stats.errorCount);
    document.getElementById('historyAvgDuration').textContent = formatUtils.formatDuration(stats.avgDuration);
    document.getElementById('historySuccessRate').textContent = stats.successRate + '%';
}

function populateRouteFilter() {
    const stats = toolLogger.getStats();
    const routes = Object.keys(stats.routeStats).sort();
    
    const select = document.getElementById('toolHistoryRoute');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">All Routes</option>' + 
        routes.map(route => `<option value="${route}">${route}</option>`).join('');
    
    select.value = currentValue;
}

function exportToolHistory(format) {
    const filters = currentFilters;
    let content, filename, mimeType;
    
    if (format === 'json') {
        content = toolLogger.export(filters);
        filename = `tool-history-${new Date().toISOString().split('T')[0]}.json`;
        mimeType = 'application/json';
    } else if (format === 'csv') {
        content = toolLogger.exportCSV(filters);
        filename = `tool-history-${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'text/csv';
    }
    
    // Create download
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    notifications.success(`Exported tool history as ${format.toUpperCase()}`);
}

function clearToolHistory() {
    if (toolLogger.clear()) {
        loadToolHistory();
        updateHistoryStats();
        notifications.success('Tool call history cleared');
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(typeof text === 'string' ? text : JSON.stringify(text, null, 2))
        .then(() => notifications.success('Copied to clipboard'))
        .catch(() => notifications.error('Failed to copy'));
}

// Keyboard shortcut: Ctrl/Cmd + H to open history
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
        e.preventDefault();
        showToolHistory();
    }
});
</script>

<style>
.rotate-180 {
    transform: rotate(180deg);
}

#toolHistoryList pre {
    font-family: 'Courier New', monospace;
}
</style>
