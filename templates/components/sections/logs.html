<!-- System Logs & Monitoring Section -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-gray-700 to-gray-900 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-clipboard-list mr-3"></i>
                    System Logs & Monitoring
                </h2>
                <p class="text-gray-300 mt-1">Detailed logging of all system operations and performance metrics</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="refreshLogs()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-md transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
                <button onclick="exportSystemLogs()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-md transition-colors">
                    <i class="fas fa-download mr-2"></i> Export
                </button>
            </div>
        </div>
    </div>

    <!-- Log Filters & Controls -->
    <div class="bg-white shadow-lg rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <input type="search" id="logSearchInput" placeholder="Search logs..." 
                   class="border border-gray-300 rounded-md px-3 py-2 text-sm"
                   oninput="filterSystemLogs()">
            
            <select id="logLevelFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm" onchange="filterSystemLogs()">
                <option value="">All Levels</option>
                <option value="debug">Debug</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
                <option value="critical">Critical</option>
            </select>
            
            <select id="logComponentFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm" onchange="filterSystemLogs()">
                <option value="">All Components</option>
                <!-- Populated dynamically -->
            </select>
            
            <input type="number" id="logLimit" value="100" min="10" max="1000" step="10"
                   class="border border-gray-300 rounded-md px-3 py-2 text-sm"
                   placeholder="Limit">
            
            <button onclick="clearSystemLogs()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-trash mr-2"></i> Clear Logs
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- Log Viewer -->
        <div class="xl:col-span-2 bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4 bg-gray-900 text-white flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center">
                    <i class="fas fa-terminal mr-2"></i>
                    Live System Logs
                </h3>
                <div class="flex items-center space-x-3">
                    <label class="flex items-center space-x-2 text-sm">
                        <input type="checkbox" id="autoScrollLogs" checked class="rounded">
                        <span>Auto-scroll</span>
                    </label>
                    <span id="logCount" class="text-sm bg-white bg-opacity-20 px-2 py-1 rounded">0 logs</span>
                </div>
            </div>
            <div id="systemLogs" class="bg-gray-950 text-green-400 p-4 font-mono text-xs overflow-y-auto" style="height: 500px; max-height: 70vh;">
                <div class="text-gray-500">System logs will appear here...</div>
            </div>
        </div>

        <!-- Statistics & Metrics -->
        <div class="space-y-6">
            <!-- Performance Metrics -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-purple-50 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>
                        Performance
                    </h3>
                </div>
                <div id="performanceMetrics" class="p-4 space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">API Calls:</span>
                        <span class="font-semibold text-gray-900" id="perfApiCalls">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Avg Response:</span>
                        <span class="font-semibold text-gray-900" id="perfAvgResponse">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Success Rate:</span>
                        <span class="font-semibold text-green-600" id="perfSuccessRate">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Error Rate:</span>
                        <span class="font-semibold text-red-600" id="perfErrorRate">-</span>
                    </div>
                </div>
            </div>

            <!-- Log Level Distribution -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-teal-50 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-chart-pie text-green-500 mr-2"></i>
                        Log Distribution
                    </h3>
                </div>
                <div id="logDistribution" class="p-4 space-y-2 text-sm">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Top Components -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-orange-50 to-red-50 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-fire text-orange-500 mr-2"></i>
                        Top Components
                    </h3>
                </div>
                <div id="topComponents" class="p-4 space-y-2 text-sm">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// System Logs Management
let systemLogData = [];
let filteredLogs = [];

async function refreshLogs() {
    const limit = parseInt(document.getElementById('logLimit').value) || 100;
    
    const result = await apiRoutes.logs.get({ limit });
    
    if (result.success && result.data.result) {
        systemLogData = result.data.result.logs || [];
        filterSystemLogs();
        updateLogStats();
        notifications.success(`Loaded ${systemLogData.length} system logs`);
    }
}

function filterSystemLogs() {
    const search = document.getElementById('logSearchInput').value.toLowerCase();
    const level = document.getElementById('logLevelFilter').value;
    const component = document.getElementById('logComponentFilter').value;
    
    filteredLogs = systemLogData.filter(log => {
        if (level && log.level !== level) return false;
        if (component && log.component !== component) return false;
        if (search && !log.message.toLowerCase().includes(search)) return false;
        return true;
    });
    
    displaySystemLogs();
}

function displaySystemLogs() {
    const container = document.getElementById('systemLogs');
    const autoScroll = document.getElementById('autoScrollLogs').checked;
    
    if (filteredLogs.length === 0) {
        container.innerHTML = '<div class="text-gray-500">No logs match your filters</div>';
        return;
    }
    
    const logsHtml = filteredLogs.map(log => {
        const levelColors = {
            debug: 'text-gray-400',
            info: 'text-green-400',
            warning: 'text-yellow-400',
            error: 'text-red-400',
            critical: 'text-red-600 font-bold'
        };
        
        const color = levelColors[log.level] || 'text-gray-400';
        const icon = log.level === 'error' || log.level === 'critical' ? '‚ùå' : 
                     log.level === 'warning' ? '‚ö†Ô∏è' : 
                     log.level === 'info' ? '‚ÑπÔ∏è' : 'üîç';
        
        return `
            <div class="hover:bg-gray-900 p-1 rounded transition-colors">
                <span class="text-gray-500">[${formatUtils.formatTime(log.timestamp)}]</span>
                <span class="${color}">${icon} ${log.level.toUpperCase()}</span>
                <span class="text-blue-400">[${log.component}]</span>
                <span class="text-gray-300">: ${log.message}</span>
                ${log.details && Object.keys(log.details).length > 0 ? `
                    <div class="ml-4 mt-1 text-gray-500 text-xs">
                        ${JSON.stringify(log.details)}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    container.innerHTML = logsHtml;
    
    // Update count
    document.getElementById('logCount').textContent = `${filteredLogs.length} logs`;
    
    // Auto-scroll to bottom
    if (autoScroll) {
        container.scrollTop = container.scrollHeight;
    }
}

function updateLogStats() {
    // Performance metrics from tool logger
    const toolStats = toolLogger.getStats();
    
    document.getElementById('perfApiCalls').textContent = formatUtils.formatNumber(toolStats.totalCalls);
    document.getElementById('perfAvgResponse').textContent = formatUtils.formatDuration(toolStats.avgDuration);
    document.getElementById('perfSuccessRate').textContent = toolStats.successRate + '%';
    document.getElementById('perfErrorRate').textContent = toolStats.errorRate + '%';
    
    // Log level distribution
    const levelCounts = {};
    systemLogData.forEach(log => {
        levelCounts[log.level] = (levelCounts[log.level] || 0) + 1;
    });
    
    const distributionHtml = Object.entries(levelCounts)
        .sort((a, b) => b[1] - a[1])
        .map(([level, count]) => {
            const colors = {
                debug: 'gray',
                info: 'blue',
                warning: 'yellow',
                error: 'red',
                critical: 'purple'
            };
            const color = colors[level] || 'gray';
            const percent = systemLogData.length > 0 ? (count / systemLogData.length * 100).toFixed(1) : 0;
            
            return `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full bg-${color}-500"></span>
                        <span class="text-gray-700 capitalize">${level}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-900 font-semibold">${count}</span>
                        <span class="text-gray-500 text-xs">(${percent}%)</span>
                    </div>
                </div>
            `;
        }).join('');
    
    document.getElementById('logDistribution').innerHTML = distributionHtml || '<div class="text-gray-500">No data</div>';
    
    // Top components
    const componentCounts = {};
    systemLogData.forEach(log => {
        componentCounts[log.component] = (componentCounts[log.component] || 0) + 1;
    });
    
    const topComponentsHtml = Object.entries(componentCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([component, count]) => `
            <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-md transition-colors">
                <span class="text-gray-700 font-medium">${component}</span>
                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-semibold">${count}</span>
            </div>
        `).join('');
    
    document.getElementById('topComponents').innerHTML = topComponentsHtml || '<div class="text-gray-500">No data</div>';
    
    // Populate component filter
    const componentFilter = document.getElementById('logComponentFilter');
    const components = Object.keys(componentCounts).sort();
    componentFilter.innerHTML = '<option value="">All Components</option>' +
        components.map(comp => `<option value="${comp}">${comp}</option>`).join('');
}

async function clearSystemLogs() {
    if (!confirm('Are you sure you want to clear all system logs?')) return;
    
    const result = await apiRoutes.logs.clear();
    
    if (result.success) {
        systemLogData = [];
        filteredLogs = [];
        displaySystemLogs();
        updateLogStats();
        notifications.success('System logs cleared');
    }
}

function exportSystemLogs() {
    const data = {
        exportDate: new Date().toISOString(),
        totalLogs: systemLogData.length,
        logs: filteredLogs.length > 0 ? filteredLogs : systemLogData
    };
    
    const content = JSON.stringify(data, null, 2);
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system-logs-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    notifications.success('System logs exported');
}

// Auto-refresh logs every 10 seconds
setInterval(() => {
    if (appState.get('currentSection') === 'logs') {
        refreshLogs();
    }
}, 10000);

// Subscribe to new tool calls to add to live log
toolLogger.subscribe((entry) => {
    if (appState.get('currentSection') === 'logs') {
        // Add synthetic log entry
        const logEntry = {
            timestamp: entry.timestamp,
            level: entry.status === 'success' ? 'info' : 'error',
            component: 'API',
            message: `${entry.method} ${entry.route} - ${entry.status}`,
            details: {
                duration: entry.duration,
                statusCode: entry.statusCode
            }
        };
        
        systemLogData.unshift(logEntry);
        filterSystemLogs();
    }
});
</script>

<style>
#systemLogs {
    scrollbar-width: thin;
    scrollbar-color: #4B5563 #1F2937;
}

#systemLogs::-webkit-scrollbar {
    width: 8px;
}

#systemLogs::-webkit-scrollbar-track {
    background: #1F2937;
}

#systemLogs::-webkit-scrollbar-thumb {
    background-color: #4B5563;
    border-radius: 4px;
}
</style>
