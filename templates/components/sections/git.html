<!-- Git & Sessions Section -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-orange-500 to-red-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-code-branch mr-3"></i>
                    Git & AI Sessions
                </h2>
                <p class="text-orange-100 mt-1">Git operations and AI-powered development sessions</p>
            </div>
            <button onclick="refreshGitInfo()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-md">
                <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Current Status -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-600 mb-1">Current Branch</div>
            <div id="currentBranchDisplay" class="text-xl font-bold text-gray-900">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-600 mb-1">Session Status</div>
            <div id="sessionStatusDisplay" class="text-xl font-bold text-gray-900">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-sm text-gray-600 mb-1">Modified Files</div>
            <div id="modifiedFilesCount" class="text-xl font-bold text-orange-600">0</div>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <!-- Session Management -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-play-circle text-green-500 mr-2"></i>
                    AI Session Management
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Session Name</label>
                    <input type="text" id="sessionName" placeholder="Optional - auto-generated if empty" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startSession()" class="bg-green-500 hover:bg-green-600 text-white py-2.5 rounded-md font-medium">
                        <i class="fas fa-play mr-2"></i> Start
                    </button>
                    <button onclick="endSession()" class="bg-red-500 hover:bg-red-600 text-white py-2.5 rounded-md font-medium">
                        <i class="fas fa-stop mr-2"></i> End
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="listSessions()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-list mr-2"></i> List All
                    </button>
                    <button onclick="getCurrentSession()" class="bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-info-circle mr-2"></i> Current
                    </button>
                </div>
                
                <div id="sessionInfo" class="bg-gray-50 border border-gray-200 rounded-md p-4 text-sm max-h-60 overflow-y-auto">
                    Session info will appear here...
                </div>
            </div>
        </div>

        <!-- Git Operations -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-terminal text-blue-500 mr-2"></i>
                    Git Operations
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">File Path (Optional)</label>
                    <input type="text" id="gitFilePath" placeholder="For file-specific operations" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Commit Message</label>
                    <input type="text" id="gitCommitMessage" placeholder="For commit operations" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="gitStatus()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-info-circle mr-1"></i> Status
                    </button>
                    <button onclick="gitBranches()" class="bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-code-branch mr-1"></i> Branches
                    </button>
                    <button onclick="gitLog()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-history mr-1"></i> Log
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="gitDiff()" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-file-alt mr-1"></i> Diff
                    </button>
                    <button onclick="gitTree()" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded-md text-sm">
                        <i class="fas fa-sitemap mr-1"></i> Tree
                    </button>
                </div>
                
                <div id="gitOutput" class="bg-gray-900 text-green-400 rounded-md p-4 text-xs font-mono max-h-80 overflow-auto">
                    Git output will appear here...
                </div>
            </div>
        </div>

        <!-- Session List -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden xl:col-span-2">
            <div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-layer-group text-purple-500 mr-2"></i>
                    Available Sessions
                </h3>
                <button onclick="listSessions()" class="text-sm text-purple-600 hover:text-purple-800">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
            </div>
            <div id="sessionsList" class="p-6">
                <!-- Sessions list populated here -->
            </div>
        </div>

        <!-- Git Branches Visualization -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden xl:col-span-2">
            <div class="px-6 py-4 bg-gradient-to-r from-indigo-50 to-blue-50 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-project-diagram text-indigo-500 mr-2"></i>
                    Branch Tree
                </h3>
            </div>
            <div id="branchTree" class="p-6 bg-gray-900 text-green-400 font-mono text-xs overflow-auto max-h-96">
                Loading branch tree...
            </div>
        </div>
    </div>
</div>

<script>
// Git & Sessions Functions
async function initGit() {
    await refreshGitInfo();
    await listSessions();
    await gitTree();
}

async function refreshGitInfo() {
    const [statusResult, sessionResult] = await Promise.all([
        apiRoutes.git.status(),
        apiRoutes.session.current()
    ]);
    
    if (statusResult.success && statusResult.data.result) {
        const status = statusResult.data.result.data?.status || {};
        
        document.getElementById('currentBranchDisplay').textContent = status.current_branch || 'unknown';
        document.getElementById('modifiedFilesCount').textContent = (status.modified_files?.length || 0) + (status.untracked_files?.length || 0);
    }
    
    if (sessionResult.success && sessionResult.data.result) {
        const isSession = sessionResult.data.result.is_session_branch;
        const sessionEl = document.getElementById('sessionStatusDisplay');
        
        if (isSession) {
            sessionEl.textContent = '🟢 Active';
            sessionEl.className = 'text-xl font-bold text-green-600';
        } else {
            sessionEl.textContent = '⚪ Inactive';
            sessionEl.className = 'text-xl font-bold text-gray-500';
        }
    }
}

async function startSession() {
    const name = document.getElementById('sessionName').value.trim() || null;
    
    showLoading('Starting new session...');
    const result = await apiRoutes.session.start(name);
    hideLoading();
    
    if (result.success) {
        const sessionName = result.data.result.session_name;
        document.getElementById('sessionInfo').innerHTML = `
            <div class="bg-green-50 border border-green-200 p-3 rounded-md">
                <div class="text-green-700 font-medium">✅ Session Started</div>
                <div class="text-sm text-green-600 mt-1">Session: ${sessionName}</div>
            </div>
        `;
        notifications.success(`Session started: ${sessionName}`);
        await refreshGitInfo();
    }
}

async function endSession() {
    const autoMerge = confirm('Merge changes to main branch when ending session?');
    
    showLoading('Ending session...');
    const result = await apiRoutes.session.end(autoMerge);
    hideLoading();
    
    if (result.success) {
        document.getElementById('sessionInfo').innerHTML = `
            <div class="bg-blue-50 border border-blue-200 p-3 rounded-md">
                <div class="text-blue-700 font-medium">✅ Session Ended</div>
                <div class="text-sm text-blue-600 mt-1">${result.data.result.message}</div>
            </div>
        `;
        notifications.success('Session ended successfully');
        await refreshGitInfo();
    }
}

async function getCurrentSession() {
    const result = await apiRoutes.session.current();
    
    if (result.success && result.data.result) {
        const data = result.data.result;
        document.getElementById('sessionInfo').innerHTML = `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-600">Branch:</span>
                    <code class="font-semibold">${data.current_branch}</code>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Is Session:</span>
                    <span class="${data.is_session_branch ? 'text-green-600' : 'text-gray-600'} font-semibold">
                        ${data.is_session_branch ? '✅ Yes' : '❌ No'}
                    </span>
                </div>
            </div>
        `;
    }
}

async function listSessions() {
    const result = await apiRoutes.session.list();
    
    if (result.success && result.data.result) {
        const sessions = result.data.result.data?.session_branches || [];
        const container = document.getElementById('sessionsList');
        
        if (sessions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-layer-group text-4xl mb-2"></i>
                    <p>No sessions found</p>
                    <button onclick="startSession()" class="mt-4 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm">
                        Start Your First Session
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${sessions.map(session => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-semibold text-gray-900">${session.name}</div>
                                <div class="text-xs text-gray-500 mt-1">${formatUtils.formatRelativeTime(session.created_at || new Date())}</div>
                            </div>
                            ${session.is_current ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Current</span>' : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="switchToSession('${session.name}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-1.5 rounded text-xs">
                                <i class="fas fa-exchange-alt mr-1"></i> Switch
                            </button>
                            <button onclick="mergeSession('${session.name}')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-1.5 rounded text-xs">
                                <i class="fas fa-code-branch mr-1"></i> Merge
                            </button>
                            <button onclick="deleteSession('${session.name}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-1.5 rounded text-xs">
                                <i class="fas fa-trash mr-1"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
}

async function switchToSession(sessionName) {
    if (!confirm(`Switch to session: ${sessionName}?`)) return;
    
    const result = await apiRoutes.session.switch(sessionName);
    
    if (result.success) {
        notifications.success(`Switched to session: ${sessionName}`);
        await refreshGitInfo();
        await listSessions();
    }
}

async function mergeSession(sessionName) {
    const message = prompt('Merge message (optional):');
    if (message === null) return;
    
    showLoading('Merging session...');
    const result = await apiRoutes.session.merge(sessionName, message || null);
    hideLoading();
    
    if (result.success) {
        notifications.success(`Session merged: ${sessionName}`);
        await refreshGitInfo();
        await listSessions();
    }
}

async function deleteSession(sessionName) {
    if (!confirm(`⚠️ Delete session: ${sessionName}?\n\nThis will delete the branch. Continue?`)) return;
    
    showLoading('Deleting session...');
    const result = await apiRoutes.session.delete(sessionName);
    hideLoading();
    
    if (result.success) {
        notifications.success(`Session deleted: ${sessionName}`);
        await refreshGitInfo();
        await listSessions();
    }
}

// Git Operations
async function gitStatus() {
    const result = await apiRoutes.git.status();
    displayGitOutput(result);
}

async function gitBranches() {
    const result = await apiRoutes.git.branches();
    displayGitOutput(result);
}

async function gitLog() {
    const result = await apiRoutes.git.log({ maxResults: 20 });
    displayGitOutput(result);
}

async function gitDiff() {
    const filePath = document.getElementById('gitFilePath').value || null;
    const result = await apiRoutes.git.diff({ filePath });
    displayGitOutput(result);
}

async function gitTree() {
    const result = await apiRoutes.git.tree();
    
    if (result.success && result.data.result) {
        const output = result.data.result.output || result.data.result.tree_view || 'No tree data';
        document.getElementById('branchTree').textContent = output;
    }
}

function displayGitOutput(result) {
    const output = document.getElementById('gitOutput');
    
    if (result.success && result.data.result) {
        const text = result.data.result.output || JSON.stringify(result.data.result, null, 2);
        output.textContent = text;
    } else {
        output.innerHTML = `<span class="text-red-400">Error: ${result.error || 'Operation failed'}</span>`;
    }
}
</script>
